<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>BodyTrack Telemetry</title>

    <style>
        body {
            background: #0d1117;
            color: #eee;
            font-family: Arial, sans-serif;
            padding: 25px;
        }

        h1 {
            color: #49a6ff;
            margin-bottom: 20px;
        }

        .grid {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .card {
            background: #1b1f28;
            padding: 15px 20px;
            border-radius: 8px;
            min-width: 200px;
            flex-grow: 1;
        }

        .card-title {
            color: #88ccff;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .value {
            font-size: 22px;
            font-weight: bold;
            color: #a7e3ff;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #1b1f28;
            border-radius: 8px;
            overflow: hidden;
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        th {
            background: #141821;
            text-align: left;
        }

        .status {
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 12px;
        }

        .ACTIVE {
            background: #4caf50;
        }

        .PAUSED {
            background: #d9a300;
        }

        .REGISTERED {
            background: #2196f3;
        }

        .ENDED {
            background: #d14444;
        }

        .UNKNOWN {
            background: #888;
        }

        .timestamp {
            text-align: right;
            margin-top: 15px;
            font-size: 13px;
            color: #bbb;
        }

        #terminateBtn {
            padding: 12px 20px;
            background: #d14444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 50px;
        }

        #refreshBtn {
            padding: 12px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 50px;
            margin-right: 15px;
        }

        #terminateModal,
        #successModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            justify-content: center;
            align-items: center;
        }

        #modalContent {
            background: #1b1f28;
            padding: 25px;
            border-radius: 8px;
            width: 350px;
        }

        #modalButtons button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
        }

        #confirmTerminate {
            background: #d14444;
            margin-right: 10px;
        }

        #cancelTerminate {
            background: #444;
        }

        #refreshSuccessModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            justify-content: center;
            align-items: center;
        }

    </style>
</head>

<body>

    <h1>BodyTrack Server Telemetry</h1>

    <div class="grid">
        <div class="card">
            <div class="card-title">Supported Exercises</div>
            <div id="supported"></div>
        </div>
        <div class="card">
            <div class="card-title">Max Clients</div>
            <div class="value" id="maxClients">0</div>
        </div>
        <div class="card">
            <div class="card-title">Registered</div>
            <div class="value" id="regSessions">0</div>
        </div>
        <div class="card">
            <div class="card-title">Active</div>
            <div class="value" id="activeSessions">0</div>
        </div>
        <div class="card">
            <div class="card-title">Paused</div>
            <div class="value" id="pausedSessions">0</div>
        </div>
        <div class="card">
            <div class="card-title">Ended</div>
            <div class="value" id="endedSessions">0</div>
        </div>
        <div class="card">
            <div class="card-title">Total Sessions</div>
            <div class="value" id="totalSessions">0</div>
        </div>
        <div class="card">
            <div class="card-title">Memory (MB)</div>
            <div class="value" id="memory">0</div>
        </div>
    </div>


    <h2 style="margin-top:35px;color:#49a6ff;">Sessions</h2>

    <table>
        <thead>
            <tr>
                <th>Session ID</th>
                <th>IP</th>
                <th>Exercise</th>
                <th>Status</th>
                <th>Extended Evaluation</th>
                <th>Analyzing State</th>
                <th>Last Activity</th>
            </tr>
        </thead>
        <tbody id="sessions"></tbody>
    </table>

    <div class="timestamp" id="ts"></div>

    <div style="text-align:center;">
        <button id="refreshBtn">Refresh Configurations</button>
        <button id="terminateBtn">Terminate Server</button>
    </div>


    <!-- Terminate Modal -->
    <div id="terminateModal">
        <div id="modalContent">
            <h3 style="margin-top:0;color:#ff6b6b;">Terminate Server</h3>
            <p>This operation will terminate the entire session and stop the server immediately.</p>

            <input type="password" id="terminatePassword" placeholder="Enter password..."
                style="width:100%;padding:8px;margin-top:15px;border-radius:4px;border:1px solid #333;background:#0d1117;color:#eee;">

            <p id="terminateError" style="color:#ff6b6b;margin-top:10px;display:none;"></p>

            <div id="modalButtons" style="margin-top:20px;text-align:right;">
                <button id="confirmTerminate">Terminate</button>
                <button id="cancelTerminate">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Success Modal -->
    <div id="successModal">
        <div style="background:#1b1f28;padding:25px;border-radius:8px;width:350px;text-align:center;">
            <h3 style="margin-top:0;color:#4caf50;">Success</h3>
            <p>Server termination command accepted.</p>
            <div style="font-size:50px;color:#4caf50;margin-top:10px;">&#10004;</div>
        </div>
    </div>

    <div id="refreshSuccessModal">
        <div style="background:#1b1f28;padding:25px;border-radius:8px;width:350px;text-align:center;">
            <h3 style="margin-top:0;color:#2196f3;">Configurations Refreshed</h3>
            <p>Server configurations were refreshed successfully.</p>
            <div style="font-size:50px;color:#2196f3;margin-top:10px;">&#10004;</div>
        </div>
    </div>

    <script>

        function prettyName(s) {
            if (!s) return "-";
            return s.split("_").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
        }

        function statusBadge(s) {
            if (!s) return `<span class="status UNKNOWN">UNKNOWN</span>`;
            return `<span class="status ${s}">${prettyName(s)}</span>`;
        }

        function renderSessions(data) {
            const tbody = document.getElementById("sessions");
            tbody.innerHTML = "";

            const sessions = data.sessions || {};
            const ipMap = data.ip_map || {};

            Object.entries(sessions).forEach(([id, s]) => {
                const ip = Object.keys(ipMap).find(k => ipMap[k] === id) || "-";
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${id}</td>
            <td>${ip}</td>
            <td>${prettyName(s.exercise_type)}</td>
            <td>${statusBadge(s.status)}</td>
            <td>${s.extended_evaluation}</td>
            <td>${prettyName(s.analyzing_state)}</td>
            <td>${s.last_activity}</td>
        `;
                tbody.appendChild(tr);
            });
        }

        function refresh() {
            fetch("http://localhost:8080/internal/telemetry")
                .then(r => r.json())
                .then(data => {
                    document.getElementById("supported").textContent =
                        data.supported_exercises.map(prettyName).join(", ");

                    document.getElementById("maxClients").textContent = data.maximum_clients;

                    document.getElementById("regSessions").textContent = data.counters.registered_sessions;
                    document.getElementById("activeSessions").textContent = data.counters.active_sessions;
                    document.getElementById("pausedSessions").textContent = data.counters.paused_sessions;
                    document.getElementById("endedSessions").textContent = data.counters.ended_sessions;
                    document.getElementById("totalSessions").textContent = data.total_sessions;

                    document.getElementById("memory").textContent = data.memory_mb.toFixed(1);
                    document.getElementById("ts").textContent = "Timestamp: " + data.timestamp;

                    renderSessions(data);
                });
        }


        document.getElementById("terminateBtn").onclick = () => {
            document.getElementById("terminateModal").style.display = "flex";
            document.getElementById("terminateError").style.display = "none";
        };

        document.getElementById("cancelTerminate").onclick = () => {
            document.getElementById("terminateModal").style.display = "none";
        };

        document.getElementById("confirmTerminate").onclick = () => {
            const pw = document.getElementById("terminatePassword").value;

            fetch("http://localhost:8080/terminate/server", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ password: pw })
            })
                .then(r => r.json())
                .then(res => {

                    if (res.message_type === 3 && res.code === 115) {
                        document.getElementById("terminateError").innerText = "Incorrect password.";
                        document.getElementById("terminateError").style.display = "block";
                        return;
                    }

                    if (res.message_type === 2 && res.response_type === 2 && res.code === 9) {
                        document.getElementById("terminateModal").style.display = "none";
                        document.getElementById("successModal").style.display = "flex";

                        setTimeout(() => {
                            document.getElementById("successModal").style.display = "none";

                            // Navigate away
                            window.location.href = "about:blank";

                            // Attempt to close (will succeed if allowed)
                            setTimeout(() => { window.close(); }, 200);

                        }, 2000);
                    }
                });
        };

        document.getElementById("refreshBtn").onclick = () => {
            fetch("http://localhost:8080/refresh/configurations", {
                method: "GET"
            })
                .then(r => r.json())
                .then(res => {
                    if (
                        res.message_type === 2 &&
                        res.response_type === 2 &&
                        res.code === 10
                    ) {
                        document.getElementById("refreshSuccessModal").style.display = "flex";

                        setTimeout(() => {
                            document.getElementById("refreshSuccessModal").style.display = "none";
                        }, 2000);
                    }
                })
                .catch(() => {
                    // Optional: log or silently ignore
                });
        };

        setInterval(refresh, 1000);
        refresh();

    </script>

</body>

</html>